#!/usr/bin/env ruby

# Updates Sublime 2 packages using the Github repositories

# Original version for Textmate found on http://blog.bleything.net/pages/mateup

ENV['LC_ALL']   = nil
ENV['LC_CTYPE'] = 'en_US.UTF-8'

github_root = 'git://github.com'
packages = {
  # 'name' => 'github_username/reponame[#branch]
  'Color Scheme - Monokai TimmFin' => 'timmfin/monokai-timmfin',
  'Git' => 'kemayo/sublime-text-2-git#python3',
  'GitGutter' => 'jisaacks/GitGutter',
  'IncDec' => 'rmaksim/Sublime-Text-2-Inc-Dec-Value',
  'JsFormat' => 'jdc0589/JsFormat',
  'LatexTools' => 'SublimeText/LaTeXTools',
  'LineEndings' => 'SublimeText/LineEndings#st3',
  'MarkdownEditing' => 'ttscoff/MarkdownEditing',
  'OpenCL' => 'oschrenk/OpenCL-Syntax',
  'PEGjs' => 'alexstrat/PEGjs.tmbundle',
  'PlainTasks' => 'aziz/PlainTasks',
  'SublimeLinter' => 'SublimeLinter/SublimeLinter#sublime-text-3',
  'Theme - Soda' => 'buymeasoda/soda-theme'
}

# packages provided by default installation
providedPackages = [
  'ActionScript',
  'AppleScript',
  'ASP',#
  'Batch File',
  'C#',
  'C++',
  'Clojure',
  'Color Scheme - Default',
  'CSS',
  'D',
  'Default',
  'Diff',
  'Erlang',
  'Go',
  'Graphviz',
  'Groovy',
  'Haskell',
  'HTML',
  'Java',
  'JavaScript',
  'Language - English',
  'LaTeX',
  'Lisp',
  'Lua',
  'Makefile',
  'Markdown',
  'Matlab',
  'Objective-C',
  'OCaml',
  'Pascal',
  'Python',
  'Perl',
  'PHP',
  'R',
  'Rails',
  'Regular Expressions',
  'RestructuredText',
  'Ruby',
  'Scala',
  'ShellScript',
  'SQL',
  'TCL',
  'Text',
  'Textile',
  'Theme - Default',
  'User',
  'Vintage',
  'XML',
  'YAML'
]

# escape spaces and ampersands
def cleanup(str)
  return str.gsub(/([ &])/, '\\\\\1')
end


def branch(source)
  if (source.nil? || source.split(/#/).length != 2)
    return "master"
  end

  return source.split(/#/)[1]
end

def packageDir()
  if RUBY_PLATFORM.downcase.include?("darwin")
    return "#{ENV['HOME']}/Library/Application\ Support/Sublime\ Text\ 3/Packages"
  elsif RUBY_PLATFORM.downcase.include?("linux")
    return "#{ENV['HOME']}/.config/sublime-text-2/Packages"
  end

  return ""
end

dir = packageDir()
begin
  Dir.chdir dir
rescue Errno::ENOENT
  puts "Packages directory doesn't exist... creating it!"
  puts

  `mkdir -p '#{dir}'`
  retry
end

Dir.entries('.').each do |e|
  next if e =~ /^\./
  next unless File.directory? e

  package_name = e.gsub(/.tmbundle$/, '')
  source = packages[package_name]
  b = branch(source)
  print "* #{package_name} #{source}: "

  if packages.delete package_name
    puts "package exists, updating"
    `cd #{cleanup e}; git pull; git checkout #{b} &> /dev/null; cd ..;`

  else
    if providedPackages.index(package_name)
      print "Ignoring provided package\n"
    else
      print "don't know about this package.  Delete it? [y/n] "

      while answer = gets
        if answer =~ /^y/
          `rm -rf #{cleanup e}`
          puts "  * deleted"
          break
        elsif answer =~ /^(n|$)/
          break
        else
          print "Please enter 'y' or 'n': "
        end
      end
    end
  end
end

packages.each do |name, source|
  puts "* #{name} doesn't exist; fetching..."
  cmd = "git clone #{github_root}/#{source} #{cleanup name}"
  `#{cmd}`.match(/(revision \d+)/)
  puts "  * checked out #{$1}"
  b = branch(source)
  if b != "master"
    `cd #{cleanup e}; git checkout #{b} &> /dev/null; cd ..;`
    puts "  * checked out #{b}"
  end
end
